<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å…¬å¼€è®°å½•è¯¦æƒ…</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7f9;
      padding: 30px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .record {
      border-bottom: 1px solid #ccc;
      padding: 15px 0;
    }
    .record img {
      max-width: 150px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .back-btn {
      margin-top: 20px;
    }
    .comment-section {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .comment-section textarea {
      width: 100%;
      height: 60px;
      margin-top: 5px;
    }
    .comment {
      font-size: 14px;
      margin-top: 5px;
      padding-left: 10px;
      border-left: 3px solid #ccc;
    }
    .comment strong {
      color: #4a90e2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ç”¨æˆ·çš„å…¬å¼€è®°å½•</h2>
    <div id="records"></div>

    <div class="comment-section">
      <p><strong>è¯„è®ºåŒºï¼š</strong></p>
      <div id="all-comments">åŠ è½½è¯„è®ºä¸­...</div>
      <textarea id="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
      <small style="color: #999;">å­—æ•°é™åˆ¶ï¼šæœ€å¤š100å­—</small>
      <button onclick="postComment()">æäº¤è¯„è®º</button>
    </div>

    <div class="back-btn"><a href="public_users.html">â† è¿”å›ç”¨æˆ·åˆ—è¡¨</a></div>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const userId = params.get('userId');
  const currentUser = JSON.parse(localStorage.getItem('user'));

  // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
  function formatDateTime(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${day} ${h}:${min}`;
  }

  if (!userId) {
    document.getElementById('records').innerHTML = '<p>ç¼ºå°‘ç”¨æˆ·IDï¼Œè¯·è¿”å›é‡è¯•ã€‚</p>';
  } else {
    fetch(`/api/public-records/${userId}`)
      .then(res => res.json())
      .then(data => {
        const recordsDiv = document.getElementById('records');
        if (!data.success || data.records.length === 0) {
          recordsDiv.innerHTML = '<p>æš‚æ— å…¬å¼€è®°å½•</p>';
          return;
        }
        data.records.forEach(record => {
          const localDate = new Date(record.record_date).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
          const div = document.createElement('div');
          div.className = 'record';
          div.innerHTML = `
            <strong>æ—¥æœŸï¼š</strong>${localDate}<br>
            <strong>æ²¹è„‚å€¼ï¼š</strong>${record.oil_level ?? 'æ— '}ï¼Œ
            <strong>ç—˜ç—˜ï¼š</strong>${record.acne_level ?? 'æ— '}ï¼Œ
            <strong>å¹²ç‡¥ï¼š</strong>${record.dryness_level ?? 'æ— '}<br>
            ${record.photo_url ? `<img src="${record.photo_url}" alt="çš®è‚¤ç…§ç‰‡">` : ''}
            <button onclick="likeRecord(${record.id})">ğŸ‘ ç‚¹èµ</button>
            <span id="like-count-${record.id}" style="margin-left:8px;color:#e67e22;"></span>
          `;
          recordsDiv.appendChild(div);
          // æŸ¥è¯¢æ¯æ¡çš®è‚¤è®°å½•çš„ç‚¹èµæ•°
          fetch(`/api/like-count/${record.id}`)
            .then(res => res.json())
            .then(likeData => {
              document.getElementById(`like-count-${record.id}`).innerText = `å…±${likeData.count || 0}èµ`;
            });
        });
      })
      .catch(err => {
        console.error('åŠ è½½å¤±è´¥', err);
        document.getElementById('records').innerHTML = '<p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
      });

    loadComments();
  }

  function likeRecord(recordId) {
    if (!currentUser || !currentUser.id) {
      alert('è¯·å…ˆç™»å½•å†ç‚¹èµ');
      return;
    }
    fetch('/api/like-record', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: currentUser.id, record_id: recordId })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
    });
  }

  function loadComments() {
    fetch(`/api/comments/${userId}`)
      .then(res => res.json())
      .then(data => {
        const commentsDiv = document.getElementById('all-comments');
        if (!data.success || !data.comments || data.comments.length === 0) {
          commentsDiv.innerHTML = '<p>æš‚æ— è¯„è®º</p>';
        } else {
          commentsDiv.innerHTML = '';
          data.comments.forEach(c => {
            const div = document.createElement('div');
            div.className = 'comment';
            div.innerHTML = `
              <strong>${c.username}ï¼š</strong>${c.content} <small>(${formatDateTime(c.created_at)})</small>
              <button onclick="showReplyInput(${c.id})">å›å¤</button>
              <div id="reply-input-${c.id}" style="margin-top:5px;"></div>
              ${c.replies && c.replies.length > 0 ? c.replies.map(r => `<div style=\"margin-left:20px;font-size:13px;\"><strong>${r.username} å›å¤ï¼š</strong>${r.content} <small>(${formatDateTime(r.created_at)})</small></div>`).join('') : ''}
            `;
            commentsDiv.appendChild(div);
          });
        }
      })
      .catch(err => {
        console.error('åŠ è½½è¯„è®ºå¤±è´¥', err);
        document.getElementById('all-comments').innerHTML = '<p>è¯„è®ºåŠ è½½å¤±è´¥</p>';
      });
  }

  function postComment() {
    const content = document.getElementById('comment-input').value.trim();
    if (!content) {
      alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
      return;
    }
    if (content.length > 100) {
      alert('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡100å­—');
      return;
    }
    if (!currentUser || !currentUser.id) {
      alert('è¯·å…ˆç™»å½•å†å‘è¡¨è¯„è®º');
      return;
    }
    fetch('/api/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: currentUser.id, target_user_id: userId, content })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('comment-input').value = '';
          loadComments();
        } else {
          alert(data.message || 'è¯„è®ºå¤±è´¥');
        }
      })
      .catch(err => {
        console.error('æäº¤è¯„è®ºå¤±è´¥', err);
        alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      });
  }

  function showReplyInput(commentId) {
    const div = document.getElementById(`reply-input-${commentId}`);
    div.innerHTML = `
      <textarea id="reply-content-${commentId}" placeholder="è¾“å…¥å›å¤å†…å®¹..."></textarea>
      <button onclick="submitReply(${commentId})">æäº¤å›å¤</button>
    `;
  }

  function submitReply(commentId) {
    const content = document.getElementById(`reply-content-${commentId}`).value.trim();
    if (!content) {
      alert('è¯·è¾“å…¥å›å¤å†…å®¹');
      return;
    }
    if (!currentUser || !currentUser.id) {
      alert('è¯·å…ˆç™»å½•å†å›å¤');
      return;
    }
    fetch('/api/reply-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: currentUser.id,
        parent_comment_id: commentId,
        content
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('å›å¤æˆåŠŸ');
        loadComments();
      } else {
        alert(data.message || 'å›å¤å¤±è´¥');
      }
    });
  }
</script>

</body>
</html>
